#GEE
// 1. Load the region of interest
var roi = table;
Map.centerObject(roi, 11);

// 2. Prepare collections with correct cloud masking
function prepCollection(start, end) {
  var l5 = ee.ImageCollection("LANDSAT/LT05/C02/T1_L2")
    .filterBounds(roi)
    .filterDate(start, end)
    .filter(ee.Filter.lt('CLOUD_COVER', 10))
    .map(maskL5sr);
    
  var l7 = ee.ImageCollection("LANDSAT/LE07/C02/T1_L2")
    .filterBounds(roi)
    .filterDate(start, end)
    .filter(ee.Filter.lt('CLOUD_COVER', 10))
    .map(maskL7sr);
  
  var merged = l5.merge(l7);
  return merged.map(function(image) {
    var lst = image.select('ST_B6')
      .multiply(0.00341802).add(149.0)
      .subtract(273.15)
      .rename('LST_C');
    return lst.clip(roi).copyProperties(image, image.propertyNames());
  });
}

// 3. Cloud masking functions
function maskL7sr(image) {
  var qa = image.select('QA_PIXEL');
  var mask = qa.bitwiseAnd(1 << 3).eq(0)
             .and(qa.bitwiseAnd(1 << 4).eq(0))
             .and(qa.bitwiseAnd(1 << 5).eq(0));
  return image.updateMask(mask);
}

function maskL5sr(image) {
  var qa = image.select('QA_PIXEL');
  var mask = qa.bitwiseAnd(1 << 3).eq(0)
             .and(qa.bitwiseAnd(1 << 4).eq(0))
             .and(qa.bitwiseAnd(1 << 5).eq(0));
  return image.updateMask(mask);
}

// 4. Overall time period
var startDate = '1999-12-01';
var endDate   = '2000-11-30';
var coll = prepCollection(startDate, endDate);
print('Landsat 5 & 7 images:', coll);

// 5. Define seasons
var seasons = [
  {name: 'Winter', start: '1999-12-01', end: '2000-02-29'},
  {name: 'Spring', start: '2000-03-01', end: '2000-05-31'},
  {name: 'Summer', start: '2000-06-01', end: '2000-08-31'},
  {name: 'Autumn', start: '2000-09-01', end: '2000-11-30'}
];

// 6. Lists to store FeatureCollections
var chartFeatures = [];
var areaFeatures = [];
var validationFeatures = [];

// 7. Function to calculate area of each class (5 classes) — output in hectares
function calcAreaByClass(clusterImg) {
  var areas = ee.List.sequence(0, 4).map(function(classNum) { 
    classNum = ee.Number(classNum);
    var mask = clusterImg.eq(classNum);
    var pixelArea = ee.Image.pixelArea().updateMask(mask);
    var totalArea_m2 = pixelArea.reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: roi,
      scale: 30,
      maxPixels: 1e13
    }).get('area');
    // If null (e.g., class does not exist in ROI), assign 0
    totalArea_m2 = ee.Algorithms.If(ee.Algorithms.IsEqual(totalArea_m2, null), 0, totalArea_m2);
    var totalArea_ha = ee.Number(totalArea_m2).divide(10000);
    return ee.Feature(null, {'Class': classNum, 'Area_ha': totalArea_ha});
  });
  return ee.FeatureCollection(areas);
}

// 8. Function to calculate clustering validation metrics (unchanged)
function calculateValidationMetrics(meanImg, result, seasonName) {
  ...
  // rest of function unchanged
}

// 9. Seasonal processing and KMeans clustering with 5 classes
seasons.forEach(function(season) {
  ...
  // Map.addLayer mean seasonal LST
  Map.addLayer(meanImg, {min:0, max:40, palette:['blue','yellow','red']}, season.name + ' Mean LST');

  // Export mean seasonal LST image
  Export.image.toDrive({
    image: meanImg,
    description: season.name + '_MeanLST',
    folder: 'GEE_Exports',
    fileNamePrefix: season.name + '_MeanLST',
    region: roi,
    scale: 30,
    crs: 'EPSG:4326',
    maxPixels: 1e13
  });

  ...
  // Map.addLayer remapped KMeans classes
  Map.addLayer(remapped_clean, {min:0, max:4, palette: palette}, season.name + ' KMeans5 Classes');

  // Export remapped KMeans classes image
  Export.image.toDrive({
    image: remapped_clean,
    description: season.name + '_KMeans5_Classes',
    folder: 'GEE_Exports',
    fileNamePrefix: season.name + '_KMeans5_Classes',
    region: roi,
    scale: 30,
    crs: 'EPSG:4326',
    maxPixels: 1e13,
    fileFormat: 'GeoTIFF'
  });

  // Calculate area of each class in hectares and add to list
  var areaFC = calcAreaByClass(remapped_clean).map(function(f) { return f.set('Season', season.name); });
  areaFeatures.push(areaFC);

  // Export class area as CSV
  Export.table.toDrive({
    collection: areaFC,
    description: season.name + '_KMeans5_Area_ha',
    folder: 'GEE_Exports',
    fileNamePrefix: season.name + '_KMeans5_Area_ha',
    fileFormat: 'CSV'
  });
});

// 10. Chart of class areas (hectares)
var allAreas = ee.FeatureCollection(areaFeatures).flatten();

var areaChart = ui.Chart.feature.groups(allAreas, 'Class', 'Area_ha', 'Season')
  .setChartType('ColumnChart')
  .setOptions({
    title: 'Temperature class area (hectares) per season (5 classes)',
    hAxis: {title: 'Temperature Class'},
    vAxis: {title: 'Area (ha)'},
    isStacked: false,
    series: {0:{color:'#08306b'},1:{color:'#6baed6'},2:{color:'#fff7bc'},3:{color:'#fb6a4a'},4:{color:'#cb181d'}}
  });

print(areaChart);

// 11. Seasonal mean LST chart
var chartFC = ee.FeatureCollection(chartFeatures);

var seasonalChart = ui.Chart.feature.byFeature(chartFC, 'Start_Date', 'Mean_LST_C')
  .setOptions({
    title: 'Seasonal mean temperature in ROI',
    hAxis: {title: 'Season start date'},
    vAxis: {title: 'Mean temperature (°C)'},
    lineWidth: 2,
    pointSize: 6
  });

print(seasonalChart);

// 12. Display clustering validation metrics as table
var validationFC = ee.FeatureCollection(validationFeatures);
print('Validation Metrics (Raw):', validationFC);

var validationTable = ui.Chart.feature.byFeature({
  features: validationFC,
  xProperty: 'Season',
  yProperties: ['Silhouette_Score', 'Calinski_Harabasz_Index', 'WCSS', 'Davies_Bouldin_Index']
}).setChartType('Table')
  .setOptions({
    title: 'KMeans clustering validation metrics per season',
    allowHtml: true,
    pageSize: 10,
    sortColumn: 'Season',
    columns: {
      Season: {label: 'Season'},
      Silhouette_Score: {label: 'Silhouette Score'},
      Calinski_Harabasz_Index: {label: 'Calinski-Harabasz Index'},
      WCSS: {label: 'Within-Cluster Sum of Squares'},
      Davies_Bouldin_Index: {label: 'Davies-Bouldin Index'}
    }
  });

print('Validation Metrics Table:', validationTable);

// 13. Export validation metrics as CSV
Export.table.toDrive({
  collection: validationFC,
  description: 'KMeans_Validation_Metrics',
  folder: 'GEE_Exports',
  fileNamePrefix: 'KMeans_Validation_Metrics',
  fileFormat: 'CSV'
});
